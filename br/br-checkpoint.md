---
title: BR 断点备份
summary: 了解如何使用断点备份功能。在快照备份过程中，BR 可以定期记录已备份的分片，从而在重试备份时恢复到离上一次退出较近的阶段。
---

# BR 断点备份 <span class="version-mark">从 v6.5 版本开始引入</span>

快照备份会因为一些可恢复性错误导致提前结束，例如硬盘空间占满、节点宕机等等一些突发情况。在 TiDB v6.5.0 之前，在错误被处理之后，之前备份的数据会被作废，你需要从新开始备份。对大规模集群来说，这造成的大量额外成本是不可忽视的。

为了能够尽可能的继续上一次的备份，从 TiDB v6.5.0 起，BR 引入了断点备份的功能，此功能需要设置参数 `use-checkpoint` 来开启。开启该功能后，备份在意外退出后可以保留上一次备份的大部分进度。

## 使用场景

如果你的 TiDB 集群规模很大，无法接受备份失败后需要重新备份的情况，那么，你可以开启断点备份功能。开启该功能后，BR 会定期记录已备份的分片，使得在下一次重试备份时回到离上一次退出时较近的进度。

## 使用方法

为 BR 设置参数 `--use-checkpoint`，你可以参考以下命令：

```shell
br backup full \
--storage s3://bkt/br_data/ --pd "${PD_IP}:2379" \
--use-checkpoint
```

## 使用限制

在备份过程中，BR 会定期向 PD 更新备份 snapshot 的 `gc-safe-point`，从而避免在备份过程中数据被 GC。当 BR 退出后，PD 中的备份 snapshot 的 `gc-safe-point` 就无法及时更新。因此，在下一次重试备份前，数据有可能已经被 GC。

目前，当 BR 开启 `use-checkpoint` 时，若没有指定具体的 `gcttl`，那么 BR 会自动设置 `gcttl` 为 15 小时，从而留出一定的反应时间。

> ** 注意： **
>
> BR 向 PD 更新 `gc-safe-point` 的时间间隔默认为 `gcttl` 的三分之一。因此若设置 `gcttl` 为 15 小时，那么当备份退出后，`gc-safe-point` 可能会保留 10 到 15 小时。

## 实现原理

在快照备份过程中，BR 将表编码成对应的键空间，并生成备份的 RPC 请求发送给所有 TiKV 节点。当接受到备份请求时，TiKV 节点会选择请求范围内的数据进行备份。每当 TiKV 节点备份完一个 `region` 级别的数据，就会返回给 BR 这段范围相关的备份信息。

通过记录这些返回给 BR 的相关备份信息，BR 就能够及时地获知已备份完成的键范围。BR 断点备份功能会定期将这些新增的相关备份信息上传至外部存储中，从而持久化存储该备份任务已完成的键范围。

在重试备份时，BR 会从外部读取备份任务曾经已完成的键范围，再与所需备份的键范围做一个差集，即可得出本次备份需要备份哪些键范围。
